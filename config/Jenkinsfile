#!groovy

def  POM_LOCATION = '-f config/pom.xml'
pipeline {
    agent any
    tools {
        maven 'maven_3_6_1'
    }
    stages {
        stage('Testing') {
            steps {
                echo '-=- execute unit tests -=-'
                sh "mvn ${POM_LOCATION} test"
            }
        }
        stage('Installation') {
            steps {
                echo '-=- installing project -=-'
                sh "mvn ${POM_LOCATION} clean install -DskipTests"
            }
        }
        stage('Packaging') {
            steps {
                echo '-=- packaging project -=-'
                sh "mvn ${POM_LOCATION} package -DskipTests"
            }
        }
        stage('Docker Build & Push') {
            steps {
                withDockerRegistry(credentialsId: 'dockerhub-id', url: 'https://index.docker.io/v1/') {
                      sh "docker build -t sergeivisotsky/airport-management:config-v2 -f config/Dockerfile ."
                      sh "docker push sergeivisotsky/airport-management:config-v2"
                }
            }
        }
        stage('Code inspection & quality gate') {
            steps {
                echo '-=- run code inspection & check quality gate -=-'
                sh "mvn ${POM_LOCATION} sonar:sonar " +
                    "-Dsonar.host.url=http://79.135.149.36:9000 " +
                    "-Dsonar.login=b85efadf5fbb9fc859538ba1dff4ae1a1aa3fa36"
            }
        }
    }
}